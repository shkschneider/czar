#include <stdint.h>
#include <stddef.h>
#include "cz.h"
#include <stdio.h>
#include <string.h>

/*
 * Integration test demonstrating all v0.3 runtime features working together
 */

/* Example struct using CZar types */
struct Color {
    u8 r;
    u8 g;
    u8 b;
    u8 a;
};

/* Initialize a color with bounds checking */
struct Color make_color(u32 r, u32 g, u32 b, u32 a) {
    struct Color c = {0};  /* Zero-initialized */

    /* Clamp values to valid range using limit constants */
    c.r = (r > U8_MAX) ? U8_MAX : cast<u8>(r);
    c.g = (g > U8_MAX) ? U8_MAX : cast<u8>(g);
    c.b = (b > U8_MAX) ? U8_MAX : cast<u8>(b);
    c.a = (a > U8_MAX) ? U8_MAX : cast<u8>(a);

    return c;
}

/* Validate color using ASSERTions */
void validate_color(struct Color* c) {
    ASSERT(c != NULL);
    /* Note: r, g, b, a are u8 types, so they're inherently in range [0, 255] */
}

/* Example of using all integer types */
struct AllTypes {
    u8  u8_field;
    u16 u16_field;
    u32 u32_field;
    u64 u64_field;
    i8  i8_field;
    i16 i16_field;
    i32 i32_field;
    i64 i64_field;
    f32 f32_field;
    f64 f64_field;
    usize usize_field;
    isize isize_field;
};

/* Initialize all types to their min/max values */
void test_all_types(void) {
    struct AllTypes types = {0};  /* Zero-initialized */

    /* Set to max values */
    types.u8_field = U8_MAX;
    types.u16_field = U16_MAX;
    types.u32_field = U32_MAX;
    types.u64_field = U64_MAX;

    /* Set to min values */
    types.i8_field = I8_MIN;
    types.i16_field = I16_MIN;
    types.i32_field = I32_MIN;
    types.i64_field = I64_MIN;

    /* Floating point */
    types.f32_field = 3.14159f;
    types.f64_field = 2.718281828459045;

    /* Size types */
    types.usize_field = USIZE_MAX;
    types.isize_field = ISIZE_MIN;

    /* Verify */
    ASSERT(types.u8_field == U8_MAX);
    ASSERT(types.i32_field == I32_MIN);

    printf("All types test: OK\n");
}

/* Example using FILE, LINE, FUNC macros */
void trace_function(const char* operation) {
    fprintf(stderr, "[TRACE] %s:%d in %s() - %s\n",
            FILE, LINE, FUNC, operation);
}

/* Safe division with error checking */
i32 safe_divide(i32 numerator, i32 denominator) {
    if (denominator == 0) {
        fprintf(stderr, "%s:%d: %s: Division by zero!\n",
                FILE, LINE, FUNC);
        return 0;
    }

    /* Check for overflow in division */
    if (numerator == I32_MIN && denominator == -1) {
        fprintf(stderr, "%s:%d: %s: Division overflow!\n",
                FILE, LINE, FUNC);
        return I32_MAX;
    }

    return numerator / denominator;
}

int main(void) {
    printf("=== CZar v0.3 Integration Test ===\n\n");

    /* Test 1: Color struct with bounds checking */
    printf("Test 1: Color struct\n");
    struct Color red = make_color(255, 0, 0, 255);
    struct Color overflow = make_color(300, 400, 500, 255);  /* Values clamped */
    validate_color(&red);
    validate_color(&overflow);
    printf("  red: rgba(%u, %u, %u, %u)\n", red.r, red.g, red.b, red.a);
    printf("  overflow (clamped): rgba(%u, %u, %u, %u)\n",
           overflow.r, overflow.g, overflow.b, overflow.a);

    /* Test 2: All types */
    printf("\nTest 2: All CZar types\n");
    test_all_types();

    /* Test 3: Runtime macros */
    printf("\nTest 3: Runtime macros\n");
    trace_function("Starting test");
    printf("  Current file: %s\n", FILE);
    printf("  Current line: %d\n", LINE);
    printf("  Current func: %s\n", FUNC);

    /* Test 4: Safe operations */
    printf("\nTest 4: Safe operations\n");
    i32 result1 = safe_divide(10, 2);
    printf("  10 / 2 = %d\n", result1);
    ASSERT(result1 == 5);

    i32 result2 = safe_divide(10, 0);
    printf("  10 / 0 = %d (handled safely)\n", result2);
    ASSERT(result2 == 0);

    i32 result3 = safe_divide(I32_MIN, -1);
    printf("  I32_MIN / -1 = %d (overflow handled)\n", result3);
    ASSERT(result3 == I32_MAX);

    /* Test 5: Zero-initialization */
    printf("\nTest 5: Zero-initialization\n");
    struct AllTypes zero_test = {0};
    ASSERT(zero_test.u32_field == 0);
    ASSERT(zero_test.i32_field == 0);
    ASSERT(zero_test.f32_field == 0.0f);
    printf("  Zero-initialization: OK\n");

    /* Test 6: Limit constants */
    printf("\nTest 6: Limit constants\n");
    ASSERT(U8_MIN == 0);
    ASSERT(U8_MAX == 255);
    ASSERT(I8_MIN == -128);
    ASSERT(I8_MAX == 127);
    ASSERT(I32_MIN < 0);
    ASSERT(I32_MAX > 0);
    ASSERT(I32_MAX > I16_MAX);
    printf("  Limit constants: OK\n");

    printf("\n=== All integration tests passed! ===\n");
    return 0;
}
