#include <stdint.h>
#include <stdio.h>

/*
 * Test struct methods
 * CZar allows defining methods on structs:
 *   RetType StructName.method_name(params) { ... }
 * This is syntax sugar for:
 *   RetType StructName_method_name(StructName* self, params) { ... }
 * 
 * Calling methods:
 *   instance.method(args) -> StructName_method(&instance, args)
 *   StructName.method(&instance, args) -> StructName_method(&instance, args)
 */

struct Vec2 {
    u8 x;
    u8 y;
};

/* Method definition - implicit self parameter */
u8 Vec2.length() {
    return self.x * self.y;
}

/* Method with explicit parameter */
void Vec2.set(u8 new_x, u8 new_y) {
    self.x = new_x;
    self.y = new_y;
}

/* Method returning struct */
Vec2 Vec2.add(Vec2 other) {
    Vec2 result = {0};
    result.x = self.x + other.x;
    result.y = self.y + other.y;
    return result;
}

/* Another struct with methods */
struct Counter {
    i32 value;
};

i32 Counter.get() {
    return self.value;
}

void Counter.increment() {
    self.value = self.value + 1;
}

void Counter.add(i32 delta) {
    self.value = self.value + delta;
}

int main(void) {
    /* Test 1: Basic method call */
    Vec2 v = {0};
    v.x = 3;
    v.y = 4;
    u8 len = v.length();
    ASSERT(len == 12);
    printf("Test 1 passed: Basic method call v.length() = %u\n", len);

    /* Test 2: Method with parameters */
    v.set(5, 6);
    ASSERT(v.x == 5);
    ASSERT(v.y == 6);
    printf("Test 2 passed: Method with parameters v.set(5, 6)\n");

    /* Test 3: Method returning struct */
    Vec2 v2 = {0};
    v2.x = 1;
    v2.y = 2;
    Vec2 v3 = v.add(v2);
    ASSERT(v3.x == 6);
    ASSERT(v3.y == 8);
    printf("Test 3 passed: Method returning struct v.add(v2)\n");

    /* Test 4: Static method call */
    Vec2 v4 = {0};
    v4.x = 2;
    v4.y = 3;
    u8 len2 = Vec2.length(&v4);
    ASSERT(len2 == 6);
    printf("Test 4 passed: Static method call Vec2.length(&v4) = %u\n", len2);

    /* Test 5: Multiple structs with methods */
    Counter c = {0};
    c.value = 10;
    i32 val = c.get();
    ASSERT(val == 10);
    c.increment();
    ASSERT(c.value == 11);
    c.add(5);
    ASSERT(c.value == 16);
    printf("Test 5 passed: Multiple structs with methods\n");

    /* Test 6: Method on pointer (auto-dereference) */
    Vec2* vp = &v;
    u8 len3 = vp.length();
    ASSERT(len3 == 30);
    printf("Test 6 passed: Method on pointer vp.length() = %u\n", len3);

    printf("All struct method tests passed!\n");
    return 0;
}
